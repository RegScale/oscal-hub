# IAM Permissions for S3 Access
# This adds S3 permissions to the EC2 instance role

Resources:
  # S3 Access Policy
  AWSEBAutoScalingGroupS3Policy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: OSCAL-S3-Access
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - s3:GetObject
              - s3:PutObject
              - s3:DeleteObject
              - s3:ListBucket
              - s3:GetBucketLocation
            Resource:
              - "arn:aws:s3:::oscal-tools-files-prod"
              - "arn:aws:s3:::oscal-tools-files-prod/*"
              - "arn:aws:s3:::oscal-tools-build-prod"
              - "arn:aws:s3:::oscal-tools-build-prod/*"
          - Effect: Allow
            Action:
              - s3:ListAllMyBuckets
            Resource: "*"
      Roles:
        - Ref: AWSEBAutoScalingGroup

  # Secrets Manager Access Policy (optional, for reading secrets)
  AWSEBAutoScalingGroupSecretsPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: OSCAL-Secrets-Access
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - secretsmanager:GetSecretValue
            Resource:
              - "arn:aws:secretsmanager:us-east-1:*:secret:oscal-tools/prod/*"
      Roles:
        - Ref: AWSEBAutoScalingGroup

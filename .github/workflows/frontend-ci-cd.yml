name: Frontend CI/CD

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'front-end/**'
      - '.github/workflows/frontend-ci-cd.yml'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'front-end/**'
      - '.github/workflows/frontend-ci-cd.yml'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '24'
  REGISTRY: docker.io
  IMAGE_NAME: oscal-ux

jobs:
  # Job 1: Run Tests
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: front-end

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: front-end/package-lock.json

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Run unit tests
        id: unit-tests
        run: |
          set -o pipefail
          npm test -- --reporter=default --reporter=json --outputFile=test-results.json 2>&1 | tee unit-test-output.txt
        continue-on-error: true

      - name: Install Playwright browsers (Chromium only for PRs)
        if: github.event_name == 'pull_request'
        run: npx playwright install chromium --with-deps

      - name: Install Playwright browsers (all browsers for branch pushes)
        if: github.event_name == 'push'
        run: npx playwright install --with-deps

      - name: Run E2E tests
        id: e2e-tests
        run: |
          set -o pipefail
          npm run test:e2e 2>&1 | tee e2e-test-output.txt
        continue-on-error: true
        env:
          BROWSER_SCOPE: ${{ github.event_name == 'pull_request' && 'chromium' || 'all' }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            front-end/test-results.json
            front-end/unit-test-output.txt
            front-end/e2e-test-output.txt
            front-end/playwright-report/
          retention-days: 30

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: front-end/playwright-report/
          retention-days: 30

      - name: Set test status
        id: test-status
        if: always()
        run: |
          if [ "${{ steps.unit-tests.outcome }}" == "success" ] && [ "${{ steps.e2e-tests.outcome }}" == "success" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "Tests passed successfully âœ…"
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "Tests failed âŒ"
            exit 1
          fi

    outputs:
      test-status: ${{ steps.test-status.outputs.status }}

  # Job 2: Build Docker Image
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: test
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile.frontend.cloudrun
          push: false
          tags: ${{ env.IMAGE_NAME }}:test
          cache-from: type=gha
          cache-to: type=gha,mode=max
          load: true

      - name: Test Docker image
        run: |
          docker run -d --name test-container -p 3000:3000 ${{ env.IMAGE_NAME }}:test
          sleep 10

          # Test health endpoint
          if curl -f http://localhost:3000/api/health; then
            echo "âœ… Health check passed"
          else
            echo "âŒ Health check failed"
            docker logs test-container
            exit 1
          fi

          docker stop test-container
          docker rm test-container

      - name: Save Docker image
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          docker save ${{ env.IMAGE_NAME }}:test | gzip > oscal-ux-image.tar.gz

      - name: Upload Docker image artifact
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: oscal-ux-image.tar.gz
          retention-days: 1

  # Job 3: PR Test Results Summary
  # Always writes to job summary; PR comments only work for non-fork PRs
  comment-pr:
    name: Test Results Summary
    runs-on: ubuntu-latest
    needs: [test, build]
    if: always() && github.event_name == 'pull_request'
    permissions:
      pull-requests: write

    steps:
      - name: Download test results
        uses: actions/download-artifact@v4
        with:
          name: test-results
          path: test-results

      - name: Parse and display test results
        id: parse-results
        run: |
          # Count test results (using || : to suppress exit code without adding extra output)
          UNIT_TESTS_PASSED=$(grep -c "âœ“" test-results/unit-test-output.txt 2>/dev/null || :)
          UNIT_TESTS_PASSED=${UNIT_TESTS_PASSED:-0}
          E2E_TESTS_PASSED=$(grep -c "passed" test-results/e2e-test-output.txt 2>/dev/null || :)
          E2E_TESTS_PASSED=${E2E_TESTS_PASSED:-0}
          UNIT_TESTS_FAILED=$(grep -c "âœ—" test-results/unit-test-output.txt 2>/dev/null || :)
          UNIT_TESTS_FAILED=${UNIT_TESTS_FAILED:-0}
          E2E_TESTS_FAILED=$(grep -c "failed" test-results/e2e-test-output.txt 2>/dev/null || :)
          E2E_TESTS_FAILED=${E2E_TESTS_FAILED:-0}

          # Determine overall status
          if [ "${{ needs.test.outputs.test-status }}" == "success" ]; then
            OVERALL_STATUS="âœ… All tests passed"
          else
            OVERALL_STATUS="âŒ Some tests failed"
          fi

          # Write to job summary (works for all PRs including forks)
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ğŸ§ª Test Results

          **Overall Status:** $OVERALL_STATUS

          ### Unit Tests
          - âœ… Passed: $UNIT_TESTS_PASSED
          - âŒ Failed: $UNIT_TESTS_FAILED

          ### E2E Tests
          - âœ… Passed: $E2E_TESTS_PASSED
          - âŒ Failed: $E2E_TESTS_FAILED

          ### Docker Build
          - Status: ${{ needs.build.result == 'success' && 'âœ… Success' || 'âŒ Failed' }}

          <details>
          <summary>ğŸ“ Unit Test Details (last 50 lines)</summary>

          \`\`\`
          $(tail -50 test-results/unit-test-output.txt 2>/dev/null || echo "No output available")
          \`\`\`

          </details>

          <details>
          <summary>ğŸ“ E2E Test Details (last 50 lines)</summary>

          \`\`\`
          $(tail -50 test-results/e2e-test-output.txt 2>/dev/null || echo "No output available")
          \`\`\`

          </details>
          EOF

          # Save outputs for PR comment step (use heredoc for values with special chars)
          echo "unit_passed=$UNIT_TESTS_PASSED" >> $GITHUB_OUTPUT
          echo "unit_failed=$UNIT_TESTS_FAILED" >> $GITHUB_OUTPUT
          echo "e2e_passed=$E2E_TESTS_PASSED" >> $GITHUB_OUTPUT
          echo "e2e_failed=$E2E_TESTS_FAILED" >> $GITHUB_OUTPUT
          {
            echo 'overall_status<<EOF'
            echo "$OVERALL_STATUS"
            echo 'EOF'
          } >> $GITHUB_OUTPUT

      - name: Comment on PR (non-fork only)
        if: github.event.pull_request.head.repo.full_name == github.repository
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            // Read test outputs
            let unitOutput = '';
            let e2eOutput = '';

            try {
              unitOutput = fs.readFileSync('test-results/unit-test-output.txt', 'utf8');
            } catch (e) {
              unitOutput = 'No unit test output available';
            }

            try {
              e2eOutput = fs.readFileSync('test-results/e2e-test-output.txt', 'utf8');
            } catch (e) {
              e2eOutput = 'No E2E test output available';
            }

            const comment = `## ğŸ§ª Test Results

            **Overall Status:** ${{ steps.parse-results.outputs.overall_status }}

            ### Unit Tests
            - âœ… Passed: ${{ steps.parse-results.outputs.unit_passed }}
            - âŒ Failed: ${{ steps.parse-results.outputs.unit_failed }}

            ### E2E Tests
            - âœ… Passed: ${{ steps.parse-results.outputs.e2e_passed }}
            - âŒ Failed: ${{ steps.parse-results.outputs.e2e_failed }}

            ### Docker Build
            - Status: ${{ needs.build.result == 'success' && 'âœ… Success' || 'âŒ Failed' }}

            <details>
            <summary>ğŸ“ Unit Test Details</summary>

            \`\`\`
            ${unitOutput.split('\n').slice(-50).join('\n')}
            \`\`\`

            </details>

            <details>
            <summary>ğŸ“ E2E Test Details</summary>

            \`\`\`
            ${e2eOutput.split('\n').slice(-50).join('\n')}
            \`\`\`

            </details>

            ---
            *Workflow run: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*
            `;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' && comment.body.includes('ğŸ§ª Test Results')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

  # Job 4: Claude Code Review
  claude-review:
    name: Claude AI Code Review
    runs-on: ubuntu-latest
    needs: [test, build]
    if: github.event_name == 'pull_request'
    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        run: |
          # Get list of changed files in the PR
          git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} > changed_files.txt

          # Filter for TypeScript/JavaScript files in front-end
          grep -E '^front-end/.*\.(ts|tsx|js|jsx)$' changed_files.txt > frontend_changed_files.txt || echo "No frontend files changed"

          # Store for next step
          echo "has_changes=$([ -s frontend_changed_files.txt ] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT

      - name: Run Claude Code Review
        if: steps.changed-files.outputs.has_changes == 'true' && env.ANTHROPIC_API_KEY != ''
        id: claude-review
        run: |
          # Prepare the diff for review
          DIFF_CONTENT=$(git diff ${{ github.event.pull_request.base.sha }} ${{ github.sha }} -- front-end/)

          # Prepare the prompt for Claude
          cat > review_prompt.txt << 'EOF'
          You are an expert code reviewer specializing in React, Next.js, TypeScript, and web application security.

          Please review the following code changes and provide feedback on:

          1. **Performance**: Identify any performance issues, inefficient algorithms, or unnecessary re-renders
          2. **Security**: Check for security vulnerabilities, XSS risks, improper data handling, or exposed secrets
          3. **Best Practices**: Ensure code follows React/Next.js best practices, proper TypeScript usage, and clean code principles
          4. **Accessibility**: Verify WCAG 2.1 AA compliance, proper ARIA labels, and keyboard navigation
          5. **Testing**: Suggest areas that need better test coverage

          Format your review as a structured markdown document with sections for each category.
          Be specific, cite line numbers or code snippets, and provide actionable recommendations.
          Only report issues if you find them - don't create false positives.

          CODE CHANGES:
          EOF

          echo "$DIFF_CONTENT" >> review_prompt.txt

          # Call Claude API (requires ANTHROPIC_API_KEY secret)
          REVIEW_RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -H "content-type: application/json" \
            -d '{
              "model": "claude-3-5-sonnet-20241022",
              "max_tokens": 4096,
              "messages": [{
                "role": "user",
                "content": "'"$(cat review_prompt.txt | jq -Rs .)"'"
              }]
            }')

          # Extract review content
          REVIEW_CONTENT=$(echo "$REVIEW_RESPONSE" | jq -r '.content[0].text // empty')

          # Check if we got valid content
          if [ -n "$REVIEW_CONTENT" ] && [ "$REVIEW_CONTENT" != "null" ]; then
            echo "$REVIEW_CONTENT" > claude_review.md
            echo "review_completed=true" >> $GITHUB_OUTPUT
          else
            # Check for error message in response
            ERROR_MSG=$(echo "$REVIEW_RESPONSE" | jq -r '.error.message // empty')
            if [ -n "$ERROR_MSG" ]; then
              echo "API Error: $ERROR_MSG" > claude_review.md
            fi
            echo "review_completed=false" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: Write Claude Review to Summary
        if: steps.changed-files.outputs.has_changes == 'true'
        run: |
          echo "## ğŸ¤– Claude AI Code Review" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ ! -f claude_review.md ]; then
            echo "â„¹ï¸ Claude code review was skipped (ANTHROPIC_API_KEY not configured)." >> $GITHUB_STEP_SUMMARY
          elif grep -q "^null$" claude_review.md 2>/dev/null; then
            echo "âš ï¸ Claude code review could not be completed. API returned no content." >> $GITHUB_STEP_SUMMARY
          elif grep -q "^API Error:" claude_review.md 2>/dev/null; then
            cat claude_review.md >> $GITHUB_STEP_SUMMARY
          else
            cat claude_review.md >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*AI-powered review by Claude*" >> $GITHUB_STEP_SUMMARY

      - name: Comment Claude Review on PR (non-fork only)
        if: steps.changed-files.outputs.has_changes == 'true' && github.event.pull_request.head.repo.full_name == github.repository
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            let reviewContent = 'â„¹ï¸ Claude code review was skipped (ANTHROPIC_API_KEY not configured).';

            try {
              const content = fs.readFileSync('claude_review.md', 'utf8').trim();
              if (content && content !== 'null') {
                reviewContent = content;
              } else {
                reviewContent = 'âš ï¸ Claude code review could not be completed. API returned no content.';
              }
            } catch (e) {
              // File doesn't exist - API key not configured
            }

            const comment = `## ğŸ¤– Claude AI Code Review

            ${reviewContent}

            ---
            *AI-powered review by Claude | [Workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*
            `;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' && comment.body.includes('ğŸ¤– Claude AI Code Review')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

  # Job 5: Deploy to Docker Hub
  deploy:
    name: Deploy to Docker Hub
    runs-on: ubuntu-latest
    needs: [test, build, claude-review]
    if: |
      github.event_name == 'push' &&
      github.ref == 'refs/heads/main' &&
      needs.test.outputs.test-status == 'success'

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile.frontend.cloudrun
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

      - name: Create deployment summary
        run: |
          echo "## ğŸš€ Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image Tags:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pull Command:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run Command:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "docker run -p 3000:3000 ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # Summary Job
  summary:
    name: CI/CD Summary
    runs-on: ubuntu-latest
    needs: [test, build, comment-pr, claude-review, deploy]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "## ğŸ“Š CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${{ needs.test.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| PR Comment | ${{ needs.comment-pr.result == 'success' && 'âœ… Posted' || needs.comment-pr.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Claude Review | ${{ needs.claude-review.result == 'success' && 'âœ… Completed' || needs.claude-review.result == 'skipped' && 'â­ï¸ Skipped' || 'âš ï¸ Warning' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy | ${{ needs.deploy.result == 'success' && 'âœ… Deployed' || needs.deploy.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY

name: CI - Build and Test

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up JDK 17 (for toolchain)
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          mvn-toolchain-vendor: 'temurin'

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          mvn-toolchain-vendor: 'temurin'
          cache: 'maven'

      - name: Set up Node.js 24
        uses: actions/setup-node@v6
        with:
          node-version: '24'
          cache: 'npm'
          cache-dependency-path: front-end/package-lock.json

      - name: Build backend with Maven
        run: |
          cd back-end
          mvn clean install -DskipTests

      - name: Run backend tests
        run: |
          cd back-end
          mvn test

      - name: Install frontend dependencies
        run: |
          cd front-end
          npm ci

      - name: Build frontend
        run: |
          cd front-end
          npm run build
        env:
          NEXT_PUBLIC_API_URL: http://localhost:8080/api
          NEXT_PUBLIC_USE_MOCK: 'false'

      - name: Run frontend tests
        run: |
          cd front-end
          npm test -- --passWithNoTests

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Run Trivy vulnerability scanner
        id: trivy
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4.32.0
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
          category: trivy
        continue-on-error: true

      - name: Set up JDK 17 (for toolchain)
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          mvn-toolchain-vendor: 'temurin'

      - name: Set up JDK 21 (for Snyk Maven)
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          mvn-toolchain-vendor: 'temurin'

      - name: Install Snyk CLI
        uses: snyk/actions/setup@master

      - name: Run Snyk for Maven
        id: snyk-maven
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
          SNYK_ORG: ${{ secrets.SNYK_ORG }}
        run: |
          snyk test --severity-threshold=high --sarif-file-output=snyk-maven.sarif --file=back-end/pom.xml

      - name: Set up Node.js (for Snyk Node)
        uses: actions/setup-node@v6
        with:
          node-version: '24'

      - name: Install frontend dependencies
        run: |
          cd front-end
          npm ci --legacy-peer-deps

      - name: Run Snyk for Node.js
        id: snyk-node
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
          SNYK_ORG: ${{ secrets.SNYK_ORG }}
        run: |
          cd front-end
          snyk test --severity-threshold=high --sarif-file-output=../snyk-node.sarif

      - name: Run Snyk for Docker
        id: snyk-docker
        uses: snyk/actions/docker@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
          SNYK_ORG: ${{ secrets.SNYK_ORG }}
        with:
          image: oscal-hub:latest
          args: --severity-threshold=high --sarif-file-output=snyk-docker.sarif --file=Dockerfile

      - name: Generate Security Scan Summary
        if: always()
        run: |
          echo "## ðŸ”’ Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Function to parse SARIF and extract vulnerabilities
          parse_sarif() {
            local file=$1
            local name=$2
            if [ -f "$file" ]; then
              local count=$(jq '[.runs[].results[]] | length' "$file" 2>/dev/null || echo "0")
              if [ "$count" -gt 0 ]; then
                echo "### $name: $count issue(s) found" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "| Severity | Rule | Message |" >> $GITHUB_STEP_SUMMARY
                echo "|----------|------|---------|" >> $GITHUB_STEP_SUMMARY
                jq -r '.runs[].results[] | "| \(.level // "warning") | \(.ruleId) | \(.message.text | gsub("\n"; " ") | .[0:100]) |"' "$file" 2>/dev/null | head -20 >> $GITHUB_STEP_SUMMARY
                if [ "$count" -gt 20 ]; then
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "*... and $((count - 20)) more. See Security tab for full details.*" >> $GITHUB_STEP_SUMMARY
                fi
                echo "" >> $GITHUB_STEP_SUMMARY
              else
                echo "### $name: âœ… No issues found" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "### $name: â­ï¸ Skipped or no results" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          }

          # Parse each scanner's results
          parse_sarif "trivy-results.sarif" "Trivy (Filesystem)"
          parse_sarif "snyk-maven.sarif" "Snyk (Maven/Java)"
          parse_sarif "snyk-node.sarif" "Snyk (Node.js)"
          parse_sarif "snyk-docker.sarif" "Snyk (Docker)"

          # Summary table
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "### Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Scanner | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Trivy | ${{ steps.trivy.outcome == 'success' && 'âœ… Passed' || steps.trivy.outcome == 'failure' && 'âŒ Failed' || 'â­ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Snyk Maven | ${{ steps.snyk-maven.outcome == 'success' && 'âœ… Passed' || steps.snyk-maven.outcome == 'failure' && 'âŒ Failed' || 'â­ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Snyk Node.js | ${{ steps.snyk-node.outcome == 'success' && 'âœ… Passed' || steps.snyk-node.outcome == 'failure' && 'âŒ Failed' || 'â­ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Snyk Docker | ${{ steps.snyk-docker.outcome == 'success' && 'âœ… Passed' || steps.snyk-docker.outcome == 'failure' && 'âŒ Failed' || 'â­ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Upload Snyk Maven results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4.32.0
        if: always() && hashFiles('snyk-maven.sarif') != ''
        with:
          sarif_file: snyk-maven.sarif
          category: snyk-maven
        continue-on-error: true

      - name: Upload Snyk Node.js results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4.32.0
        if: always() && hashFiles('snyk-node.sarif') != ''
        with:
          sarif_file: snyk-node.sarif
          category: snyk-node
        continue-on-error: true

      - name: Upload Snyk Docker results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4.32.0
        if: always() && hashFiles('snyk-docker.sarif') != ''
        with:
          sarif_file: snyk-docker.sarif
          category: snyk-docker
        continue-on-error: true

      - name: Check for high severity vulnerabilities
        if: always()
        run: |
          FAILED=""
          if [ "${{ steps.trivy.outcome }}" == "failure" ]; then
            FAILED="$FAILED Trivy"
          fi
          if [ "${{ steps.snyk-maven.outcome }}" == "failure" ]; then
            FAILED="$FAILED Snyk-Maven"
          fi
          if [ "${{ steps.snyk-node.outcome }}" == "failure" ]; then
            FAILED="$FAILED Snyk-Node"
          fi
          if [ -n "$FAILED" ]; then
            echo "::error::High severity vulnerabilities found by:$FAILED. Check the Security tab and workflow summary for details."
            exit 1
          fi

name: CI - Build and Test

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up JDK 17 (for toolchain)
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          mvn-toolchain-vendor: 'temurin'

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          mvn-toolchain-vendor: 'temurin'
          cache: 'maven'

      - name: Set up Node.js 18
        uses: actions/setup-node@v6
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: front-end/package-lock.json

      - name: Build backend with Maven
        run: |
          cd back-end
          mvn clean install -DskipTests

      - name: Run backend tests
        run: |
          cd back-end
          mvn test

      - name: Install frontend dependencies
        run: |
          cd front-end
          npm ci

      - name: Build frontend
        run: |
          cd front-end
          npm run build
        env:
          NEXT_PUBLIC_API_URL: http://localhost:8080/api
          NEXT_PUBLIC_USE_MOCK: 'false'

      - name: Run frontend tests
        run: |
          cd front-end
          npm test -- --passWithNoTests

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Run Trivy vulnerability scanner
        id: trivy
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4.31.9
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
          category: trivy
        continue-on-error: true

      - name: Set up JDK 21 (for Snyk Maven)
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Run Snyk for Maven
        id: snyk-maven
        uses: snyk/actions/maven@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
          SNYK_ORG: ${{ secrets.SNYK_ORG }}
        with:
          args: --severity-threshold=high --sarif-file-output=snyk-maven.sarif --file=back-end/pom.xml

      - name: Set up Node.js (for Snyk Node)
        uses: actions/setup-node@v6
        with:
          node-version: '18'

      - name: Install frontend dependencies
        run: |
          cd front-end
          npm ci --legacy-peer-deps

      - name: Run Snyk for Node.js
        id: snyk-node
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
          SNYK_ORG: ${{ secrets.SNYK_ORG }}
        with:
          args: --severity-threshold=high --sarif-file-output=snyk-node.sarif --file=front-end/package.json

      - name: Run Snyk for Docker
        id: snyk-docker
        uses: snyk/actions/docker@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
          SNYK_ORG: ${{ secrets.SNYK_ORG }}
        with:
          image: oscal-hub:latest
          args: --severity-threshold=high --sarif-file-output=snyk-docker.sarif --file=Dockerfile

      - name: Upload Snyk Maven results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4.31.9
        if: always() && hashFiles('snyk-maven.sarif') != ''
        with:
          sarif_file: snyk-maven.sarif
          category: snyk-maven
        continue-on-error: true

      - name: Upload Snyk Node.js results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4.31.9
        if: always() && hashFiles('snyk-node.sarif') != ''
        with:
          sarif_file: snyk-node.sarif
          category: snyk-node
        continue-on-error: true

      - name: Upload Snyk Docker results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4.31.9
        if: always() && hashFiles('snyk-docker.sarif') != ''
        with:
          sarif_file: snyk-docker.sarif
          category: snyk-docker
        continue-on-error: true

      - name: Check for high severity vulnerabilities
        if: always()
        run: |
          FAILED=""
          if [ "${{ steps.trivy.outcome }}" == "failure" ]; then
            FAILED="$FAILED Trivy"
          fi
          if [ "${{ steps.snyk-maven.outcome }}" == "failure" ]; then
            FAILED="$FAILED Snyk-Maven"
          fi
          if [ "${{ steps.snyk-node.outcome }}" == "failure" ]; then
            FAILED="$FAILED Snyk-Node"
          fi
          if [ -n "$FAILED" ]; then
            echo "::error::High severity vulnerabilities found by:$FAILED. Check the Security tab for details."
            exit 1
          fi
